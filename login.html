<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ุฏุงุนู | ููุตุฉ ุฏุนู ููุณู</title>
    <link rel="icon" type="image/png" href="imgs/icon.png">
    <link rel="stylesheet" href="css/normalize.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/login.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="css/all.min.css" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet" />
  </head>
  <body>

    <!-- Start Header -->
    <div class="header" id="header">
      <div class="container">
        <a href="index.html" class="logo">ุฏุงุนู</a>
        <ul class="main-nav">
          <li><a href="index.html">ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</a></li>
          <li><a href="index.html#about">ูู ูุญู</a></li>
          <li><a href="index.html#features">ุงููููุฒุงุช</a></li>
          <li><a href="index.html#tests">ุงูุงุฎุชุจุงุฑุงุช ุงูููุณูุฉ</a></li>
          <li>
            <a href="#">ุงููุฒูุฏ</a>
            <!-- Start Megamenu -->
            <div class="mega-menu">
              <ul class="links">
                <li>
                  <a href="more-success.html"><i class="fas fa-comments fa-fw"></i>ูุตุต ูุฌุงุญ</a>
                </li>
                <li>
                  <a href="index.html#team"><i class="fas fa-user fa-fw"></i>ูุฑูู ุฏุงุนู</a>
                </li>
                <li>
                  <a href="index.html#faq-container"><i class="fas fa-question-circle"></i> ุฃุณุฆูุฉ ุดุงุฆุนุฉ</a>
                </li>
              </ul>
              <ul class="links">
                <li>
                  <a href="index.html#stats"><i class="far fa-chart-bar fa-fw"></i> ุฅุญุตุงูุงุชูุง</a>
                </li>
                <li>
                  <a href="index.html#subscribe"><i class="fas fa-envelope-open-text"></i>ุงุดุชุฑู ูุนูุง</a>
                </li>
              </ul>
            </div>
            <!-- End Megamenu -->
          </li>
        </ul>
    <div class="header-buttons">
     <a href="login.html#loginForm" class="btn login-btn">ุชุณุฌูู ุงูุฏุฎูู</a>
      <a href="login.html#registerForm" class="btn start-btn">ุงุจุฏุฃ ุงูุขู</a>
    </div>
      </div>
    </div>
    <!-- End Header -->

<br><br>
<div class="login" id="login">
    <div class="container">
        <img class="avatar" src="imgs/login.png" alt="ุฑูุฒ ุฏุงุนู">
    <h2>ูุฑุญุจูุง ุจู ูู ููุตุฉ ุฏุงุนู</h2>
    <hr>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('login')">ุชุณุฌูู ุงูุฏุฎูู</div>
        <div class="tab" onclick="switchTab('register')">ุฅูุดุงุก ุญุณุงุจ</div>
    </div>

    <form id="loginForm" class="active">
      <input type="text" id="login-username" placeholder=" ุงุณู ุงููุณุชุฎุฏู" required>
      <input type="password" id="login-password" placeholder="ูููุฉ ุงููุฑูุฑ" required>
        <button type="submit">ุฏุฎูู</button>
        <a href=""><div class="note">ูุณูุช ูููุฉ ุงููุฑูุฑุ</div></a>
        <h4>ุฃู</h4>
        <button type="button" class="google-btn">ุชุณุฌูู ุงูุฏุฎูู ุนุจุฑ Google <img src="imgs/google-icon.svg"></button>
    </form>

    <form id="registerForm">
      <input type="text" id="reg-username" placeholder="ุงุณู ุงููุณุชุฎุฏู  " required>
      <input type="email" id="reg-email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" required>
      <select id="reg-role" required>
        <option value="client">ูุณุชุฎุฏู</option>
        <option value="therapist">ูุนุงูุฌ ููุณู</option>
      </select>
      <input type="password" id="reg-password" placeholder="ูููุฉ ุงููุฑูุฑ" required>
      <input type="password" id="reg-password2" placeholder="ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ" required>
        <button type="submit">ุฅูุดุงุก ุงูุญุณุงุจ</button>
        <h4>ุฃู</h4>
        <button type="button" class="google-btn">ุชุณุฌูู ุงูุญุณุงุจ ุนุจุฑ Google <img src="imgs/google-icon.svg"></button>
    </form>
    </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function switchTab(tab) {
      const tabs = document.querySelectorAll('.tab');
      const forms = document.querySelectorAll('form');
      tabs.forEach(t => t.classList.remove('active'));
      forms.forEach(f => f.classList.remove('active'));

      document.querySelector(`.tab:nth-child(${tab === 'login' ? 1 : 2})`).classList.add('active');
      document.getElementById(`${tab}Form`).classList.add('active');
    }

    document.addEventListener("DOMContentLoaded", function () {
      if (window.location.hash === "#registerForm") {
        switchTab('register');
        document.getElementById("registerForm").scrollIntoView({ behavior: "smooth" });
      } else if (window.location.hash === "#loginForm") {
        switchTab('login');
        document.getElementById("loginForm").scrollIntoView({ behavior: "smooth" });
      }


    

    // โ ููุง ูุชู ุชูููุฐ ุงูุทูุจ ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุฏุฎูู"
    const loginForm = document.getElementById('loginForm');
    loginForm.addEventListener('submit', function (e) {
      e.preventDefault();

      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;

      fetch('http://127.0.0.1:8000/api/token/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          username: username,  // ุฃู "email" ุญุณุจ ุฅุนุฏุงุฏุงุชู
          password: password
        })
      })
    .then(res => {
      if (!res.ok) {
        // ูุญุงูู ูุฑุงุกุฉ ุฑุณุงูุฉ ุงูุฎุทุฃ ูู ุงูุฑุฏ ูู ูุชููุฑุฉ
        return res.json().then(errData => {
          // ูุจุญุซ ุนู ุฑุณุงูุฉ ุฎุทุฃ ูุญุชููุฉ ูู ุงูุจูุงูุงุช
          const errorMsg = errData.detail || errData.message || "ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ";
          throw new Error(errorMsg);
        }).catch(() => {
          // ูู ูุดููุง ูู ูุฑุงุกุฉ jsonุ ูุฑูู ุฑุณุงูุฉ ุนุงูุฉ
          throw new Error("ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ");
        });
      }
      return res.json();
    })

      .then(data => {
        console.log("ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ:", data);
        // ุญูุธ ุงูุชูููุงุช ูู localStorage
        localStorage.setItem('access', data.access);
        localStorage.setItem('refresh', data.refresh);
        console.log("Access Token:", data.access);
        // โ ุทูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู ููุนุฑูุฉ ููุนู (client ุฃู therapist)
      return fetch('http://127.0.0.1:8000/me/', {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + data.access,
          'Content-Type': 'application/json',
        }
        
      }).then(res => {
        if (!res.ok) {
          throw new Error("ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู");
        }
        return res.json();
      });
    })
    .then(user => {
      console.log("ุจูุงูุงุช ุงููุณุชุฎุฏู:", user);

      // ุฑุณุงูุฉ ุชุฑุญูุจ ุญุณุจ ุงูุฏูุฑ
      Swal.fire({
        icon: 'success',
        title: `ูุฑุญุจูุง ${user.username}`,
        text: `ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ! ุฌุงุฑู ุชุญูููู ุฅูู ุตูุญุชู`,
        timer: 3000,
        showConfirmButton: false,
        timerProgressBar: true
      }).then(() => {
        // ุชุญููู ุญุณุจ ุงูุฏูุฑ
        if (user.role === 'therapist') {
          window.location.href = 'therapist.html';
        } else {
          window.location.href = 'user.html';
        }
      });
    })
      .catch(err => {
        console.error("ุฎุทุฃ:", err);
        alert("ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู: " + err.message);
      });
    });







const registerForm = document.getElementById('registerForm');

registerForm.addEventListener('submit', function (e) {
  e.preventDefault();

  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const password2 = document.getElementById('reg-password2').value;
  const role = document.getElementById('reg-role').value;

  // ุงูุชุญูู ูู ุชุทุงุจู ูููุชู ุงููุฑูุฑ
  if (password !== password2) {
    Swal.fire({
      icon: 'error',
      title: 'ุฎุทุฃ',
      text: 'โ ูููุชุง ุงููุฑูุฑ ุบูุฑ ูุชุทุงุจูุชูู',
      timer: 2500,
      showConfirmButton: false
    });
    return;
  }

  fetch('http://127.0.0.1:8000/users/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, email, password, role })
  })
    .then(res => res.json().then(data => ({ status: res.status, body: data })))
    .then(result => {
      if (result.status === 201) {
        Swal.fire({
          icon: 'success',
          title: 'ุชู ุงูุชุณุฌูู',
          text: 'โ ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญุ ููููู ุชุณุฌูู ุงูุฏุฎูู ุงูุขู',
          timer: 2000,
          showConfirmButton: false
        }).then(() => {
          switchTab('login');
        });
      } else {
        const errors = result.body.errors || result.body;
        let errorMsg = '';

        if (errors.email) errorMsg += `๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุฌูุฏ ูุณุจูุงู\n`;
        if (errors.username) errorMsg += `๐ค ุงุณู ุงููุณุชุฎุฏู ููุฌูุฏ ูุณุจูุงู\n`;
        if (errors.password) errorMsg += `๐ ูููุฉ ุงููุฑูุฑ: ${errors.password[0]}\n`;
        if (errors.role) errorMsg += `๐ก๏ธ ุงูุฏูุฑ: ${errors.role[0]}\n`;

        if (!errorMsg) errorMsg = result.body.message || 'โ ูุดู ุงูุชุณุฌูู. ุชุญูู ูู ุงูุจูุงูุงุช ุงููุฏุฎูุฉ.';

        Swal.fire({
          icon: 'error',
          title: 'ุฎุทุฃ ูู ุงูุชุณุฌูู',
          text: errorMsg
        });
        console.error('ุชูุงุตูู ุงูุฎุทุฃ:', errors);
      }
    })
    .catch(err => {
      console.error('โ๏ธ ุฎุทุฃ ูู ุงูุงุชุตุงู ุฃู ูู ุงูุฎุงุฏู:', err);
      Swal.fire({
        icon: 'error',
        title: 'ุฎุทุฃ',
        text: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูุญุณุงุจ. ุญุงูู ูุงุญููุง.'
      });
    });
});


  });
  </script>




</body>
</html>
